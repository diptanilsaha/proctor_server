{% extends 'candidate/base.html' %}

{% block content %}
<header class="flex-shrink-0">
    <div class="container">
        <div class="d-flex flex-wrap justify-content-between align-items-center py-3 px-3 mb-4 border-bottom">
            <h3 class="mb-0">{{ config['INSTITUTE_NAME'] }}</h3>
            <div class="d-flex flex-column align-items-end">
                <p class="mb-0"><strong>Client: </strong>{{ client_session.client.name }}</p>
                <p class="mb-0"><strong>Client Session: </strong>{{ client_session.id }}</p>
            </div>
        </div>
    </div>
</header>
<main>
    <div class="container">
        {% import 'macros.html' as macros %}
        {{ macros.error() }}
        <div class="w-75 mx-auto px-2">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">{{ candidate.assessment.title }}</h2>
                <div class="py-1 px-2 border border-dark rounded" id="candidateStatus">
                    <strong>{{ candidate.current_status.name }}</strong>
                </div>
            </div>
            <hr>
            <h5>Instruction/Description</h5>
            <p>{{ candidate.assessment.description }}</p>

            <a href="{{ url_for('candidate.assessment_media', filename=candidate.assessment.media) }}" class="btn btn-dark mb-3"><strong>Download Reference Material</strong></a>

            {% if candidate.current_status.name == 'SUBMITTED' or candidate.current_status.name == 'VERIFIED' %}
            <a href="{{ url_for('candidate.submission_file', filename=candidate.submission_media_url) }}" class="btn btn-success mb-3"><strong>View your work</strong></a>
            {% endif %}

            {% if form is defined %}
            <div class="px-5 py-4 border rounded">
                <h3>Turn in your work</h3>
                <form action="{{ url_for('candidate.assessment_view', pk=candidate.id) }}" method="post" enctype="multipart/form-data">
                    {{ form.csrf_token }}
                    <div class="mb-3">
                        {{ form.submission.label(class_="form-label") }}
                        {{ form.submission(class_="shadow-sm w-100 form-control", accept=".zip,.rar,.7zip")}}
                    </div>
                    <button type="submit" class="btn btn-success">Turn In</button>
                </form>
            </div>
            {% endif %}

            {% if candidate.current_status.name == 'VERIFIED' %}
            <div class="px-5 py-4 border rounded">
                <h3>Submission Verified.</h3>
                <p>Dear Candidate, your submission has been verified. You can proceed to leave this PC.</p>
                <p>Thank You.</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

{% block js_script %}
<script>
    function reloadSite(data) {
        const status = document.getElementById('candidateStatus')
        if(data.hasOwnProperty('assessment')) {
            if(status.innerText !== data['assessment']['currentStatus']) {
                location.reload()
            }
        } else {
            location.reload()
        }
    }

    function fetchStatus() {
        fetch('data')
            .then(function(response) {
                return response.json()
            })
            .then(function(data) {
                reloadSite(data)
            })
            .catch(function(err){
                console.log('error: ' + err)
            });
    }

    window.addEventListener('load', function () {
        // Your document is loaded.
        var fetchInterval = 3000; // 5 seconds.

        // Invoke the request every 5 seconds.
        setInterval(fetchStatus, fetchInterval);
    });
</script>
{% endblock %}
